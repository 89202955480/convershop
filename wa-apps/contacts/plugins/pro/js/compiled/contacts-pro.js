$.wa.search={state:null,init:function(h,k){var n={};h[0]&&(n.hash=h[0]);if(h[1]&&"0"!==h[1])this.search(h);else{var a=h[0];try{a=decodeURIComponent(a)}catch(b){}a=encodeURIComponent(a);n.hash=a;$.wa.controller.setBlock();$("#c-core .c-core-content").load("?plugin=pro&module=search",n,function(){var a=$("#c-search-container").find("form");a.bind("contacts_search",function(a,b){b?$.wa.setHash("#/contacts/search/"+b+"/1/"):$("#c-search-message").text($_("No search conditions specified")).show()});$.wa.controller.setTitle($_("Search contacts"));
a.find(':input:not([type="hidden"])').change(function(){$("#c-search-message").hide();return false}).end().find("input:not(.datepicker)").keydown(function(){$("#c-search-message").hide()});k==="new_filter"&&$("#c-search-container .c-new-filter-text").show()})}},search:function(h){var k=h[0],n=k;try{n=decodeURIComponent(n)}catch(a){}n=encodeURIComponent(n);if(k){var b=$.wa.controller.parseParams(h.slice(2));h[5]||(b.view="list");var c=$.wa.controller.parseCustomFields(h,"search");$.wa.controller.needAddCustomFields(h,
"search")?$.wa.controller.addCustomFields(c):($("#c-contacts-count-text").hide(),$.wa.controller.showLoading(),$.wa.controller.loadGrid($.extend({},b,{query:"search/"+n+"/",custom_fields:c}),"/contacts/search/"+k+"/1/","?plugin=pro&module=contacts&action=list",{beforeLoad:function(){$.wa.controller.setBlock("contacts-list");$("#c-searching").hide();$("#contacts-container").removeClass("no-border")},afterLoad:function(a){if(a.count>0){var e="/contacts/search/"+k+"/1/"+$.wa.grid.getHash();$("#c-searching").hide();
b.view!=="map"&&b.view!=="thumbs"&&$.wa.controller.addCustomFieldsControl(a,e,c)}e=[];a.can_change_search_conditions&&e.push('<li><a href="#/contacts/search/'+n+'/">'+$_("Change search conditions")+"</a></li>");a.can_save_as_filter&&e.push('<li><a href="javascript:void(0);" id="c-save-as-filter">'+$_("Save as filter")+"</a></li>");var i=$(".wa-page-heading").css("width","100%").contents().wrapAll('<div class="wa-page-heading-text"></div>').end().prepend(e.length?'<ul class="menu-v float-right wa-page-heading-links">'+
e.join(" ")+"</ul>":"").closest(".block");i.find(".wa-page-heading-text").append('<i class="icon16 loading" style="display:none;"></i>');$("#c-save-as-filter").click(function(){$(".wa-page-heading",i).hide();$.wa.controller.appendViewSettingsBlock(i,a);return false});$(".wa-page-heading").after('<div class="wa-page-subheading" style="margin-top: 20px;">'+a.count_html+"</div>")}}))}},serialize:function(h,k,n){for(var a={},b=h.serializeArray(),h=0,c=b.length;h<c;h+=1){var d=(b[h].value||"").trim();
try{d=JSON.parse(d)}catch(e){}var i=b[h].name;if(i&&d&&(!$.isPlainObject(d)||!$.isEmptyObject(d))&&!(k&&0!==i.indexOf(k))&&!(void 0!==n&&-1===i.indexOf("["+n+"]"))){for(var g=""+($.isPlainObject(d)?d.val:d),d=$.isPlainObject(d)?d.op||"=":"=",g=g.replace(/\//g,"\\/").replace(/&/,"\\&"),i=i.split("."),m=a,l=0,f=i.length-1;l<f;l+=1){var j=(i[l]||"").trim();if("undefined"===typeof m[j]||"object"!==typeof m[j])m[j]={};m=m[j]}j=i[i.length-1];$.isArray(m[j])?m[j].push({val:g,op:d}):$.isPlainObject(m[j])||
(m[j]=[{val:g,op:d}])}}var o=function(a,b,c){if($.isPlainObject(a))for(var d in a)a.hasOwnProperty(d)&&o(a[d],b,c?c+"."+d:d);else"undefined"!==typeof a&&(b[c]=a)},k={};o(a,k,"");var a=[],p;for(p in k)if(k.hasOwnProperty(p))if($.isArray(k[p])&&1<k[p].length){h=0;for(c=k[p].length;h<c;h+=1)a.push(p+"["+h+"]"+k[p][h].op+encodeURIComponent(k[p][h].val))}else a.push(p+k[p][0].op+encodeURIComponent(k[p][0].val));return a.join("&")},indexBlocks:function(h){var k={},n=$('#c-search-block .js-field[data-multiple="1"]');
h&&(n=n.filter('[data-id="'+h+'"]'));n.each(function(){var a=$(this),b=a.data("id"),c=void 0!==k[b]?++k[b]:k[b]=0;a.attr("data-index",c);a.data("index",c);a.find(":input").each(function(){var a=$(this),e=a.attr("name").replace(/\[\d+\]/,"").replace(b,b+"["+c+"]");a.attr("name",e)})})}};(function(){$.wa.controller=$.extend($.wa.controller||{},{search_cache:!1,data:{},contactAction:function(a){var b={};a[1]&&(b={tab:a[1]});this.lastView&&null!==this.lastView.hash&&(b.last_hash=this.lastView.hash,b.sort=this.lastView.sort,b.offset=this.lastView.offset);this.showLoading();this.load("#c-core","?module=contacts&action=info&id="+a[0],b,function(){this.setBlock("contacts-info")},function(){$("#tc-contact").bind("after_switch_mode.contacts-pro",function(a,b,c){$.wa.controller.initCompanyInput(b,
c)});$.wa.controller.initCompanyInput("view",$.wa.contactEditor);$("#t-activity").length&&$("#t-user").after($("#t-activity"));var a=$("#tc-user-status-field");a.find(".c-user-status-online, .c-user-status-offline").length&&$('<a class="small" href="javascript:void(0);">'+$_("activities")+"</a>").appendTo(a.find(".value").append()).click(function(){$("#t-activities").click()})})},initCompanyInput:function(a,b){if("person"===b.contactType){var c=$(b.el),d=c.find(".field.company");d.find(".value").css({width:"100%"});
var e=function(a){if(a&&"0"!==a){var c=d.find(".value"),f=c.find(".top");if(!(f.length&&f.data("id")==a)){d.find(".loading").show();var e="?plugin=pro&module=contacts&action=infoTop&id="+a;b.wa_backend_url&&(e=b.wa_backend_url+"contacts/"+e);$.get(e,function(e){d.find(".loading").hide();if(e&&"ok"===e.status){f.remove();c.append('<div class="top" id="c-company-top-info" data-id="'+a+'"></div>');if(!$.isEmptyObject(e.data)){for(var i='<ul class="menu-v compact">',g=0;g<e.data.length;g+=1)var j=e.data[g],
i=i+("<li>"+("im"!=j.id?j.icon?'<i class="icon16 '+j.id+'"></i>':"":"")+j.value+"</li>");c.find(".top").append(i+"</ul>")}b.fieldEditors.company_contact_id.setValue(a)}},"json")}}},i=b.fieldEditors.company_contact_id.getValue();i&&"0"!==i&&(e(i),d.find(".val").contents().wrapAll('<a href="#/contact/'+i+'/" class="no-underline bold"></a>'));if("edit"==a){c.find(".subname:not(.title)").each(function(){var a=$(this).find("input:first").width();$(this).find("input:first").width(a*0.75)});var g=!1;d.find(".val").autocomplete({source:"?plugin=pro&module=contacts&action=companies",
select:function(a,b){if(b.item.id){e(b.item.id,$(this));$(this).data("contact_id",b.item.id);d.find(".val").val(b.item.name);a.keyCode==13?setTimeout(function(){g=false},200):g=false}},close:function(a){$(".jobtitle-company-wrapper").removeClass("gray");a.keyCode==13?setTimeout(function(){g=false},200):g=false},open:function(){$(".jobtitle-company-wrapper").addClass("gray");$(this).data("contact_id",0);g=true},clear:function(){b.fieldEditors.company_contact_id.setValue(0);d.find(".val").val("");$("#c-company-top-info").remove()},
keyup:function(){b.fieldEditors.company_contact_id.setValue(0)}}).keyup(function(a){if(a.keyCode===13&&!g)return false}).keydown(function(a){a.keyCode==13&&!g&&$("#contact-info-block input[type=submit]:last").click()})}}},contactsImportAction:function(a){this.setBlock();if("results"==a[0])return this.contactsImportResults(a.slice(1));var b=$("#c-core .c-core-content");"upload"==a[0]?this.load(b,"?plugin=pro&module=import&action=upload"+(a[1]?"&"+a[1]:"")):this.load(b,"?plugin=pro&module=import")},
contactsImportResults:function(a){this.setBlock("contacts-list");var b=this.parseParams(a.slice(1),"import/results/"+a[0]);b.query="/import/results/"+a[0];this.loadGrid(b,"/contacts/import/results/"+a[0]+"/","?plugin=pro&module=contacts&action=list")},fconstructorAction:function(){this.load($("#c-core"),"?plugin=pro&module=constructor&action=main&type=personal")},usersAllAction:function(a){this.showLoading();a=this.parseParams(a,"users/all");a.query="/users/all/";a.fields=["name","email","company",
"_access"];this.loadGrid(a,"/users/all/","?plugin=pro&module=contacts&action=list",{beforeLoad:function(){this.setBlock("contacts-users",$_("All users"),["group-actions"])},afterLoad:function(a){$("#sb-all-users-li span.count").html(a.count);$("#c-core .sidebar ul.stack li:first").addClass("selected");$(".c-service-column").show().width("20px")}})},contactsGroupAction:function(a){if(a&&a[0]){var b=this.parseParams(a.slice(1),"contacts/group/"+a[0]);b.fields=["name","email","company","_access"];b.query=
"group/"+a[0];$(".wa-page-heading").css({width:""});this.loadGrid(b,"/contacts/group/"+a[0]+"/","?plugin=pro&module=contacts&action=list",{beforeLoad:function(b){this.current_group_id=a[0];if(0<b.count)this.setBlock("contacts-users",null,["group-settings","group-actions"]);else return this.setBlock("contacts-users",null,"group-settings"),$("#contacts-container").html('<div class="block double-padded" style="margin-top: 35px;"><p>'+$_("No users in this group.")+"</p> <p>"+$_('To add users to group, go to <a href="#/users/all/">All users</a>, select them, and click <strong>Actions with selected / Add to group</strong>.')+
"</p></div>"),!1},afterLoad:function(b){$('#list-group li[rel="group'+a[0]+'"]').children("span.count").html(b.count)}})}},usersAddAction:function(){this.checkAdminRights(function(){this.setBlock("contacts-users",$_("New user"),!1);$(".wa-page-heading").find(".loading").hide();$(".contacts-data").html('<div class="block double-padded"><p>'+$_('You can grant access to your account backend to any existing contact. To do so, <a href="#/contacts/search/">find a contact</a> and then customize access rights on Account tab.')+
"</p><p>"+$_('Or <a href="#/contacts/add/">create a new contact</a> and customize access rights on Account tab.')+"</p></div>")})},contactsAddNoteAction:function(){this.load($("#c-core"),"?plugin=pro&module=notes&action=add")},contactsAddEventAction:function(){$("#c-events-edit-event-dialog-container").remove();this.load($("#c-core"),"?plugin=pro&module=events&action=edit",{},null,function(){1<$.wa.controller.hashes.length&&"events"===$.wa.controller.hashes[1].split("/")[0]&&$(".c-cancel-panel").show().find(".cancel").click(function(){window.history.back();
return!1});$("#save-event-form").bind("after_save",function(){$.wa.controller.updateAddNewBlock("event");$.wa.setHash("#/events/all/0/0/30/event/")})})},contactsAddAction:function(a){this.showLoading();this.setBlock("contacts-info");if("note"===a[0])return this.contactsAddNoteAction(a.slice(1));if("event"===a[0])return this.contactsAddEventAction(a.slice(1));var b=a&&"company"===a[0]?1:0;this.load($("#c-core .c-core-content"),"?module=contacts&action=add&company="+b,{},function(){$.wa.controller.clearLastView();
a[0]?$.wa.controller.updateAddNewBlock("company"):$.wa.controller.updateAddNewBlock("person")},function(){"person"===$.wa.contactEditor.contactType?$.wa.controller.setTitle($_("New person"),!0):$.wa.controller.setTitle($_("New company"),!0);$.wa.controller.initCompanyInput("edit",$.wa.contactEditor);$(window).scroll()})},initNoteInlineEditors:function(a){var a=a||{},b=$("#c-notes");b.on("click",".edit",function(){var c=$(this),d=c.closest(".c-note").find(".c-note-text");d.inlineEditable({inputType:"textarea",
size:{width:400,height:100},editLink:c,editOnItself:!1,makeReadableBy:[],beforeMakeEditable:function(b){d.closest(".c-note").find(".error").removeClass("error").end().find(".errormsg").remove();b.next(".buttons").length||(b.after('<div class="buttons" style="margin-top: 6px;"><input type="button" class="button green" value="'+$_("Save")+'"> '+$_("or")+' <a href="javascript:void(0);" class="cancel" style="display: inline-block">'+$_("cancel")+"</a></div>"),b.next().find(".cancel").click(function(){d.closest(".c-note").find(".error").removeClass("error").end().find(".errormsg").remove();
b.next(".buttons").hide();d.trigger("readable",[!1,!0])}).end().find(".button").click(function(){d.data("save",1).trigger("readable")}));b.next().show();"function"===typeof a.beforeMakeEditable&&a.beforeMakeEditable.apply(this,arguments)},beforeBackReadable:function(b,c){d.closest(".c-note").find(".error").removeClass("error").end().find(".errormsg").remove();if("function"===typeof a.beforeBackReadable&&!1===a.beforeBackReadable.apply(this,arguments))return!1;if(d.data("save")&&c.changed&&!b.val().trim())return b.addClass("error").after('<em class="errormsg">'+
$_("Required field")+"</em>"),!1;b.next(".buttons").hide()},afterBackReadable:function(c,i){var g=b.data("appUrl")||"";d.html(c.val().trim().replace(/\n/g,"<br>\n"));if(d.data("save")&&i.changed){d.data("save",0);var m=d.closest(".c-note");$.post(g+"?plugin=pro&module=notes&action=save",{id:m.data("id"),text:c.val()},function(c){c&&"ok"===c.status&&(m.find(".author-info").html(c.data.creator.name+", "+c.data.create_datetime_str),b.hasClass("resort-on-save")&&m.closest("li").prependTo(b),"function"===
typeof a.onSave&&a.onSave.call(d,c))},"json")}else i.changed&&d.text(i.old_text.trim());"function"===typeof a.afterBackReadable&&a.afterBackReadable.apply(this,arguments)}}).trigger("editable")})},notesAllAction:function(a){var b=function(a){var b={offset:0,order:0,count:30,query:""};a[0]&&(b.offset=parseInt(a[0],10)||0);a[1]&&(b.order=parseInt(a[1],10)||0);a[2]&&(b.count=parseInt(a[2],10)||30);a[3]&&(b.query=a[3]);return b},c=function(){var a=location.hash.indexOf("notes/all/"),b="";-1!==a&&(b=location.hash.slice(a+
10),b=b.split("/"));return b},d=function(a){return"#/notes/all/"+a.offset+"/"+a.order+"/"+a.count+"/"+(a.query?a.query+"/":"")},a=b(a);this.load($("#c-core"),"?plugin=pro&module=notes",a,null,function(){$(window).scrollTo(0);var a=function(){var a=[];$(".notes-search").each(function(){var b=$(this),c=b.val().trim();c&&(c=c.replace(/&/,"\\&"),a.push(b.attr("name")+"="+encodeURIComponent(c)))});var e=c(),e=b(e);e.query="";a.length&&(e.query=a.join("&"));location.hash=d(e)};$(".notes-search").bind("search",
function(){a();return!1}).keydown(function(b){if(13==b.keyCode)return a(),!1}).change(function(){if(!$(this).val())return a(),!1}).bind("input",function(){if(!$(this).val())return a(),!1});$("#c-notes-paging").bind("choose_page",function(a,e){var m=c(),m=b(m);m.offset=e;$.wa.setHash(d(m))});$("#c-notes-paging .items-per-page").bind("change",function(){var a=c(),a=b(a);a.count=parseInt($(this).val(),10);a.offset=0;$.wa.setHash(d(a))});$.wa.controller.initNoteInlineEditors({beforeMakeEditable:function(){$(this).show().parent().find(".trancated").hide()},
onSave:function(a){$(this).closest(".item-row").find(".datetime").html(a.data.create_datetime_str)}});$("#c-notes-container").find(".sort").bind("click",function(){var a=c(),a=b(a);a.order=+!a.order;location.hash=d(a)}).end().find(".more").bind("click",function(){$(this).closest("td").find(".trancated").hide().end().find(".full").show()}).end().find(".delete").bind("click",function(){var a=$(this).closest("tr"),b=a.data("id");b&&confirm($_("Are you sure?"))&&($(this).after(' <i class="icon16 loading"></i>'),
$.post("?plugin=pro&module=notes&action=delete",{id:b,counter:1},function(b){"ok"===b.status&&(a.remove(),a.closest("tbody").find(".item-row:first").length||$(".c-hide-on-empty-notes").hide(),b.data.counters&&(b=parseInt(b.data.counters.all,10)||0,$("#c-all-notes-li .count").text(b),$("#notes-paging .total").text(b)),$.wa.controller.redispatch())},"json"))}).end()})},eventEditDialog:function(a){$("#c-events-edit-event-dialog-container").remove();var b=$('<div id="c-events-edit-event-dialog-container"></div>').appendTo("body");
b.load("?plugin=pro&module=events&action=editDialog&id="+a,function(){var a=b.find(".dialog");a.waDialog({onLoad:function(){a.find("form").bind("after_delete",function(){$.wa.controller.redispatch();a.trigger("close");return!1})},onSubmit:function(){var b=$(this);b.find(".dialog-buttons .loading.save").show();b.bind("after_save",function(){b.find(".loading.save").hide();a.trigger("close");$.wa.controller.redispatch()});b.trigger("save");return!1},onCancel:function(){$("#c-events-edit-event-dialog-container").remove()}})})},
eventsAllAction:function(a){var b=function(a){var b={offset:0,order:0,count:30,category:"log",query:"",extra:null};a[0]&&(b.offset=parseInt(a[0],10)||0);a[1]&&(b.order=parseInt(a[1],10)||0);a[2]&&(b.count=parseInt(a[2],10)||30);a[3]&&(b.category=a[3]);a[4]&&(b.query=a[4]);a[5]&&(b.extra=a[5]);return b},c=function(){var a=location.hash.indexOf("events/all/"),b="";-1!==a&&(b=location.hash.slice(a+11),b=b.split("/"));return b},d=function(a){return"#/events/all/"+a.offset+"/"+a.order+"/"+a.count+"/"+
a.category+"/"+(a.query?a.query+"/":"")},e=function(a){for(var b={},a=a.split("&"),c=0;c<a.length;c+=1){var d=a[c].split("=");d[0]&&d[1]&&(b[d[0]]=d[1])}return b},i=function(a){var b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(c+"="+a[c]);return b.join("&")},g=function(a){var a=a.replace(/^[^#]*#\/*/,""),b=$.isEmptyObject($.wa.controller.hashes)||$.wa.controller.hashes[0]!==a;b&&$("#c-events-content").find(".title .loading").show();$.wa.setHash(a);return b},m=function(){var a=$("#c-log-records").find("tbody"),
b=$("#c-log-records").find(".graphics"),c=b.length?b.offset().top:a.offset().top;$("#c-log-records-cover").css({position:"absolute",left:a.offset().left,top:c,height:a.height()+(b.length?b.height():0),width:a.width(),zIndex:99});b=$("#c-log-records-cover-loading").show();b.css({position:"absolute",left:a.offset().left+(a.width()-b.width())/2,top:a.offset().top,zIndex:100})},l=b(a);this.load($("#c-core"),"?plugin=pro&module=events",l,null,function(){$(window).scrollTo(0);var a=$("#c-events-content");
"log"===l.category&&(!l.query&&"0"==l.offset)&&($("#c-events-content").queue(function q(a){var b=$(this),c=$("#c-log-records tbody tr:first").data("datetime");c&&($.post("?plugin=pro&module=events&action=new",{datetime:c},function(a){$("<table></table>").html(a).find("tr").prependTo($("#c-log-records tbody")).each(function(){var a=$(this),b=$.Color(a.find("td:first").css("background-color")).toHexString();a.addClass("c-new-record");a.data("color",b);a.find("td").css({backgroundColor:"#FFFF00"})})},
"html"),b.delay(6E4).queue(q),a())}),$(window).unbind("mousemove.events").bind("mousemove.events",function(){$("#c-log-records").length?$("#c-log-records tbody").find(".c-new-record").each(function(){var a=$(this);a.find("td").animate({backgroundColor:a.data("color")},5E3,function(){$(this).parent().removeClass("c-new-record")})}):$(this).unbind("mousemove.events")}));if("event"===l.category&&l.extra){var j=e(l.extra);j.event_id&&$.wa.controller.eventEditDialog(j.event_id)}$("#c-records-paging").bind("choose_page",
function(a,e){var f=c(),f=b(f);f.offset=e;g(d(f))});$("#c-records-paging .items-per-page").bind("change",function(){var a=c(),a=b(a);a.offset=0;a.count=parseInt($(this).val(),10);g(d(a))});var h=function(a,f,j){var f=a.periodDialog("formatDate","yy-mm-dd",f),a=a.periodDialog("formatDate","yy-mm-dd",j),j=b(c()),l=e(j.query);l.period=f+" - "+a;j.query=i(l);f=d(j);g(f)};$("#c-events-filter-period").change(function(){if($(this).val()!=="select_period"){m();var a=b(c()),f=e(a.query);f.period=$(this).val();
a.query=i(f);a=d(a);g(a)}else{$("#c-events-filter-select-period").remove();var j=$('<div id="c-events-filter-select-period"></div>').appendTo("body");j.periodDialog().bind("select",function(a,b,c){h(j,b,c)}).bind("cancel",function(){var a=b(c()),a=e(a.query);a.period&&$("#c-events-filter-period").find('option[value="'+a.period+'"]').attr("selected",true)})}});$("#c-events-filter-change-custom-period").click(function(){$("#c-events-filter-select-period").remove();var a=$('<div id="c-events-filter-select-period"></div>').appendTo("body");
a.periodDialog({start_datetime:$(this).data("start"),end_datetime:$(this).data("end")}).bind("select",function(b,c,d){h(a,c,d)})});$("#c-events-calendar .c-choose-month").find(".month:not(.year)").click(function(){var a=b(c()),f=e(a.query);f.month=$(this).data("month");a.query=i(f);a=d(a);g(a)});$("#c-events-calendar .c-choose-month").find(".year a").bind("click",function(){var a=b(c()),f=e(a.query);f.year=$(this).data("year");a.query=i(f);a=d(a);g(a)});$("#c-events-calendar .c-back-year-month").click(function(){var a=
b(c()),f=e(a.query);delete f.year;f.month=$(this).data("month");a.query=i(f);a=d(a);g(a)});$("#c-events-choose-category a").click(function(){var a=c(),a=b(a);a.category=$(this).data("value");a.query="";g(d(a));return false});$(".block-list",a).bind("item_selected",function(a,f,j){f=j.split("=");a=f[0];f=f[1];(""+f)[0]==="%"&&(f="");var j=c(),j=b(j),l=e(j.query);if(!(f&&l[a]===f)){m();f?l[a]=f:delete l[a];j.offset=0;j.query=i(l);g(d(j))}});$(".block-list",a).bind("show_all",function(a,b){$(this).trigger("item_selected",
[$(this).attr("id"),b])});$(".filters",a).bind("close",function(){var a=b(c());a.query="";a=d(a);g(a);$(this).hide()})})},setData:function(a){this.data=a},"export":function(){var a=$.wa.grid.getSelected();if(!(0>=a.length)){var b=null,c=null,d=$("#c-export-dialog");(d.length?d.parent():$("<div></div>").appendTo("body")).load("?plugin=pro&module=export",{selected_count:a.length,all_count:$.wa.grid.count},function(){var a=$("#c-export-dialog");a.waDialog({onLoad:function(){$("#c-export-loading").hide();
$(".c-hide-on-export").show()},disableButtonsOnSubmit:!0,onSubmit:function(){var a=$(this);$("#c-export-loading").show();$(".c-hide-on-export").hide();if(!a.find("input.field_id").length)return!1;a.find(".loading").show();var d=a.serializeArray();if("selected"===a.find("input[name=exportwho]:checked").val()){a=$.wa.grid.getSelected(!0);if(0>=a.length)return!1;d.push({name:"hash",value:"id/"+a.join(",")})}else a=location.hash.replace(/^[^#]*#\/*/,""),d.push({name:"hash",value:a});var e=0,l=function(a){e--;
if(b&&a.ready&&(a=b))b=null,clearTimeout(c),$('<form id="c-export-form-ready-'+a+'" action="?plugin=pro&module=export&action=export&processid='+a+'" method="post"><input type="hidden" name="file" value="1" /></form>').appendTo($("body")),$("#c-export-form-ready-"+a).submit(function(){$.wa.dialogHide();$.wa.grid.selectItems($("#c-select-all-items").attr("checked",!1))}).submit()},f=function(){if(2>e){if(null===b)return;$.get("?plugin=pro&module=export&action=export",{processid:b,t:Math.random()},l,
"json");e++}c=setTimeout(f,3200)};$.post("?plugin=pro&module=export&action=export",d,function(a){a.processId||alert("Error processing request.");b=a.processId;f()},"json");return!1},onCancel:function(){clearTimeout(c);$.post("?plugin=pro&module=export&action=export",{processid:b,ready:1});a.trigger("close")}})})}},graph:function(a,b,c){var d="",e=null,i=[];if("month"==c)d="%d %b",e="10 days";else if("week"==c)d="%d %b",e="1 day";else if("today"==c)d="%d %b %H:00",e="0.2 day";else if("year"==c)d="%d %Y",
e="1 month";else if(b.length)if(d=b[b.length-1][2]-b[0][2],86400>d)d="%d %b %H:00",e="0.2 day";else if(604800>d)d="%d %b",e="1 day";else{for(var d="%d %b %Y",c=Math.ceil(b.length/5),g=0;g<b.length;g+=1)0===g%c&&i.push(b[g][0]);i.push(b[b.length-1][0])}for(var g=c=0,m=b.length;g<m;g+=1)if(c<(parseFloat(b[g][1])||0))c=parseFloat(b[g][1])||0;g=1;if(c){if(10<c){for(g=10;0<Math.floor(c/g);)g*=10;g/=10;c=0!=c%10?Math.ceil(c/g)*g:Math.ceil(c/g)*g+g}}else c=1;$("#"+a).css({minWidth:"500"});var l=$.jqplot(a,
[b],{height:200,seriesColors:"#3b7dc0 #129d0e #a38717 #ac3562 #1ba17a #87469f #6b6b6b #686190 #b2b000 #00b1ab #76b300".split(" "),gridPadding:{right:40,left:40},series:[{color:"#129d0e",yaxis:"y2axis",shadow:!1,lineWidth:3,fill:!0,fillAlpha:0.1,fillAndStroke:!0,rendererOptions:{highlightMouseOver:!1}}],grid:{borderWidth:0,shadow:!1,background:"#ffffff",gridLineColor:"#eeeeee"},axes:{xaxis:{renderer:$.jqplot.DateAxisRenderer,showTickMarks:!1,tickOptions:{formatString:d},tickInterval:e,ticks:i,min:b[0][0],
max:b[b.length-1][0]},y2axis:{min:0,max:c,showTickMarks:!1,tickOptions:{formatString:"%d"},tickInterval:g}},highlighter:{show:!0,sizeAdjust:7.5},cursor:{show:!1}});$(window).unbind("resize.events-overflow.plot").bind("resize.events-overflow.plot",function(){$("#"+a).length?l.replot():$(this).unbind("resize.events-overflow.plot")})},parseCustomFields:function(a,b){var c={search:7,view:6,all:5}[b]||0,d=[];if(c&&a[c])for(var c=a[c].split("&"),e=0;e<c.length;e+=1){var i=c[e].trim();i&&d.push(i)}return d},
narrowCustomFieldsControl:function(){var a=$("#show-custom-fields-menu .edit-column .text");$(".view-list").find(".c-service-th").css({width:"20"}).addClass("min-width");var b=$("#show-custom-fields");b.css("left",-b.width()+20);a.hide()},expandCustomFieldsControl:function(){var a=$("#show-custom-fields-menu");$(".view-list").find(".c-service-th").removeClass("min-width").width($("#show-custom-fields").css("width")).append(a);a=$("#show-custom-fields-menu .edit-column .text").show();$("#show-custom-fields").css("left",
-1.6*a.width())},customFieldsControlCheckItems:function(a){$("#show-custom-fields a").each(function(){var b=$(this),c=b.data("id");-1!==a.indexOf(c)?b.find(".icon10").css("opacity",1):b.find(".icon10").css("opacity",0)})},addCustomFieldsControl:function(a){if(!$.isEmptyObject(a.metrics)){$("#show-custom-fields").length&&$("#show-custom-fields").closest("ul.dropdown").remove();$(".view-list").find(".c-service-th").show().width(230).append('<ul class="menu-h dropdown animated float-right" style="display:inline-block" id="show-custom-fields-menu"><li><a href="javascript:void(0)" class="edit-column"><span class="text small" data-width="">'+
$_("Display a column")+'</span><i class="icon10 darr"></i></a><ul class="menu-v with-icons" id="show-custom-fields" style="width: 230px;"></li></ul></ul>');$(".view-list").find(".c-service-column").show();$("#contacts-container").find(".contacts-data .list-with-custom-fields").length?$.wa.controller.narrowCustomFieldsControl():$.wa.controller.expandCustomFieldsControl();var b="",a=a.metrics,c;for(c in a)a.hasOwnProperty(c)&&(b+='<li><a href="#" class="toggle-custom-field" data-id="'+c+'"><i class="icon10 yes" style="opacity: 0;"></i> '+
a[c].name+"</a></li>");$("#show-custom-fields").html(b);$(document).off("click",".toggle-custom-field").on("click",".toggle-custom-field",function(){var a=$(this).data("id"),b=$.wa.controller.getHash()||"#/contacts/all/",b=b.replace(/^[^#]*#\/*/,""),c=b.split("/"),d=c[1]||"all",c=c.slice(2),c=$.wa.controller.parseCustomFields(c,d);-1===c.indexOf(a)?(c.push(a),a=$.wa.controller.parseHash(b,d),a.custom_fields=c.join("&"),b=$.wa.controller.makeHash(a,d),$.wa.setHash("#/"+b)):$.wa.controller.deleteCustomField(a);
return!1});var d=[];$(".custom-field-th").each(function(){d.push($(this).data("field-id"))});this.customFieldsControlCheckItems(d)}},addCustomFields:function(a,b){for(var c=$.wa.grid.data.contacts||[],d=[],e=0,i=c.length;e<i;e+=1)d.push(c[e].id);if(!$.isEmptyObject(a)&&!$.isEmptyObject(c)){$.isArray(a)||(a=[a]);$.wa.grid.data.fields=$.wa.grid.data.fields||{};for(var g in $.wa.grid.data.fields)$.wa.grid.data.fields.hasOwnProperty(g)&&"Custom"===$.wa.grid.data.fields[g].type&&delete $.wa.grid.data.fields[g];
for(e=0;e<a.length;e+=1)i=$.extend({},$.wa.grid.data.metrics[a[e]],{type:"Custom"}),$.wa.grid.data.fields[i.id]=i;var m=$("#show-custom-fields-menu"),l=function(){$(".view-list").find(".c-service-th").append(m).end().find(".c-service-column").show()},e=$("#contacts-container .contacts-data");e.html($.wa.grid.view($.wa.grid.settings.view,$.wa.grid.data));var f=e.find(".c-list-top-line .custom-field-td:last").append(' <i class="icon16 loading"></i>').find(".loading");l();this.customFieldsControlCheckItems(a);
this.narrowCustomFieldsControl();d={contacts:d,custom_fields:a};if(b=parseInt(b,10))d.view_id=b;var j=this;$.post("?plugin=pro&module=contacts&action=listFields",d,function(b){if("ok"===b.status){for(var d=b.data,e=0,i=c.length;e<i;e+=1)$.wa.grid.data.contacts[e]=$.extend(c[e],d.contacts[c[e].id]||{});$.wa.grid.data.fields=b.data.fields;b=$("#contacts-container .contacts-data");f.remove();b.html($.wa.grid.view($.wa.grid.settings.view,$.wa.grid.data));l();j.customFieldsControlCheckItems(a);j.narrowCustomFieldsControl()}},
"json")}},diffHashes:function(a,b,c){var a=this.parseHash(a,c),b=this.parseHash(b,c),c=[],d;for(d in a)a.hasOwnProperty(d)&&a[d]!=b[d]&&c.push(d);return c},parseHash:function(a,b){var c=(a||"").split("/"),c=c.slice(2);return"view"===b?$.extend({},{id:c[0]||"0",offset:c[1]||"0",sort:c[2]||"name",order:c[3]||"1",view:c[4]||"table",limit:c[5]||"30",custom_fields:c[6]||""}):"search"===b?$.extend({},{hash:c[0]||"",load_contacts:c[1]||"0",offset:c[2]||"0",sort:c[3]||"name",order:c[4]||"1",view:c[5]||"list",
limit:c[6]||"30",custom_fields:c[7]||""}):$.extend({},{offset:c[0]||"0",sort:c[1]||"name",order:c[2]||"1",view:c[3]||"table",limit:c[4]||"30",custom_fields:c[5]||""})},makeHash:function(a,b){var c="contacts/"+b+"/",d=a.custom_fields;$.isArray(d)&&(d=d.join("/"));d=[a.offset,a.sort,a.order,a.view,a.limit,d].join("/");return"view"===b?c+a.id+"/"+d:"search"===b?c+[a.hash,a.load_contacts].join("/")+"/"+d:c+d},needAddCustomFields:function(a,b){var c=$.wa.controller.parseCustomFields(a,b);return!$.isEmptyObject(c)&&
1<$.wa.controller.hashes.length?(c=$.wa.controller.diffHashes($.wa.controller.hashes[0],$.wa.controller.hashes[1],b),0>=c.length||1===c.length&&0<=c.indexOf("custom_fields")):!1},contactsAllAction:function(a){var a=a||[],b=this.parseParams(a,"contacts/all"),a=$(".wa-page-heading").height();$(".wa-page-heading-text").length?$(".wa-page-heading-text").html($_("Loading...")+'<i class="icon16 loading"></i>'):this.showLoading();this.setBlock("contacts-list");$(".wa-page-heading").css({height:a});this.loadGrid(b,
"/contacts/all/","?plugin=pro&module=contacts&action=list",{afterLoad:function(a){$("#sb-all-contacts-li span.count").html(a.count);var d=$(".wa-page-heading").css({width:"100%"}).contents().wrapAll('<div class="wa-page-heading-text float-left"></div>').end();if(!$.isEmptyObject(a.abc)&&!$("#c-abc-index").length){d.css({height:""});var e=$('<div class="block not-padded" id="c-abc-index"></div>').appendTo(d).html(tmpl("template-contacts-abc-index",{abc:a.abc,params:$.extend({order:1,offset:0,view:b.view,
sort:"name",limit:30},b,{view:"map"!==b.view?b.view:"table"})}));e.find(".c-abc-index-list").append($.wa.grid.getPaging(a.count,!1,!1));var i=e.find(".c-abc-index-list"),a=e.offset(),g=e.width(),m=d.height();i.hide();var l=d.height();d.css({height:l});e.css($.extend({position:"absolute",zIndex:98,width:g},a)).appendTo("body").find(".c-toggle-abc-index").click(function(){var a=$(this).closest(".c-abc-index").find(".c-abc-index-list");a.toggle();a.is(":hidden")?$(".wa-page-heading").css({height:l}):
$(".wa-page-heading").css({height:m});return!1});e.off("click.abc-index",".c-abc-index-list-ul a").on("click.abc-index",".c-abc-index-list-ul a",function(){i.find("li.selected").removeClass("selected");$(this).closest("li").addClass("selected")});$("#sb-all-contacts-li").unbind("click.abc-index").bind("click.abc-index",function(){var a=$("#c-abc-index .c-abc-index-list");a.length?a.find("li.selected").removeClass("selected"):$(this).unbind("click.abc-index")});$(document).off("click.abc-index",".paging a").on("click.abc-index",
".paging a",function(){var a=$("#c-abc-index .c-abc-index-list");a.length?a.find("li.selected").removeClass("selected"):$(document).off("click.abc-index",".paging a")});$(window).unbind("resize.abc-index").bind("resize.abc-index",function(){var a=$("#c-abc-index");a.length||$(this).unbind("resize.abc-index");a.width($(".wa-page-heading").width());a.find(".c-abc-index-list").is(":hidden")||$(".wa-page-heading").height(a.height())})}else if($.isEmptyObject(a.abc))$("#c-abc-index").remove();else{e=$("#c-abc-index");
e.find(".paging").replaceWith($.wa.grid.getPaging(a.count,!1,!1));var d=$("<div></div>").html(tmpl("template-contacts-abc-index",{abc:a.abc,params:$.extend({order:1,offset:0,view:b.view,sort:"name",limit:30},b,{view:"map"!==b.view?b.view:"table"})})),f=-1;e.find(".c-abc-index-list-ul").find("li").each(function(a){if($(this).hasClass("selected"))return f=a,!1}).end().replaceWith(d.find(".c-abc-index-list-ul"));-1!==f&&e.find(".c-abc-index-list-ul li:eq("+f+")").addClass("selected");d.remove()}$("#c-abc-index").find(".c-abc-index-list-ul li:first a").attr("href",
"#/")}})},contactsTagAction:function(a){var b=this.parseParams(a.slice(1),"contacts/tag/"+a[0]);b.query="/tag/"+a[0];this.loadGrid(b,"/contacts/tag/"+a[0]+"/","?plugin=pro&module=contacts&action=list",{beforeLoad:function(){$.wa.controller.setBlock("contacts-list")}})},contactsViewAddAction:function(){this.setBlock("contacts-list",$_("New list"));this.hideLoading();$("#contacts-container").find(".contacts-data").hide().end().find(".c-list-toolbar").hide();var a=$(".wa-page-heading").before('<span class="float-right c-view-settings-toggle-span" style="margin-top: 7px; margin-right: 10px;"><a href="javascript:void(0);" class="c-view-settings-toggle float-right"><i class="icon16 settings"></i></a></span>').closest(".block");
$(".wa-page-heading",a).hide();$.wa.controller.appendViewSettingsBlock(a,{info:{type:"new_view"},title:$_("New list"),hash_ar:["view"],icons:$.wa.controller.view_icons});$("#c-view-name").focus().select();$("#c-view-cancel").unbind("click").click(function(){var a=$.wa.controller.hashes;a[1]&&"contacts/view/add/"!==a[1]?$.wa.setHash(a[1]):$.wa.setHash("#")});$(".c-view-settings-toggle-span").hide()},contactsViewAction:function(a,b){if(a[0]&&"add"===a[0])this.contactsViewAddAction();else{var c=this.parseParams(a.slice(1),
"contacts/view/"+a[0]);c.query="/view/"+a[0];this.highlightSidebar();this.loadGrid(c,"/contacts/view/"+a[0]+"/","?plugin=pro&module=contacts&action=list",{beforeLoad:function(c){if(!c.info||!c.info.id||c.info.id!=a[0])return $.wa.setHash("#/contacts/all/"),!1;$.wa.controller.current_view_id=a[0];c.info&&("list"===c.info.type||"category"===c.info.type&&!c.info.system_id)?this.setBlock("contacts-list",void 0,["list-actions",""]):this.setBlock("contacts-list");$(".wa-page-heading",e).css({display:"block",
maxWidth:"100%"});if(!$.isEmptyObject(c.info)&&"view"===c.hash_ar[0]&&(c.user.is_admin||c.user.id==c.info.contact_id)){var e=$(".wa-page-heading").before('<span class="float-right c-view-settings-toggle-span" style="margin-top: 7px; margin-right: 10px;"><a href="javascript:void(0);" class="c-view-settings-toggle float-right"><i class="icon16 settings"></i></a></span>').closest(".block"),i=function(a){("category"!==c.info.type||!c.info.system_id&&!c.info.app_id)&&$(".wa-page-heading",e).hide();$.wa.controller.appendViewSettingsBlock(e,
c);a&&$("#c-view-name").focus().select()};$(".c-view-settings-toggle").click(function(){$(".c-view-settings").is(":not(:hidden)")?$("#c-view-cancel").click():i();return!1});b&&!$(".c-view-settings").is(":not(:hidden)")&&i(!0)}},afterLoad:function(b){var c=$(".c-view-list");c.length&&$('li[data-id="'+a[0]+'"]',c).children("span.count").html(b.count);if(!$.isEmptyObject(b.fields)){var c=[],i;for(i in b.fields)b.fields.hasOwnProperty(i)&&"Custom"===b.fields[i].type&&c.push(i);c.length&&(b=$.wa.controller.hashes[0],
b=$.wa.controller.parseHash(b,"view"),b.custom_fields=c.join("&"),b=$.wa.controller.makeHash(b,"view"),$.wa.controller.stopDispatch(1),$.wa.setHash("#/"+b))}}})}},appendViewSettingsBlock:function(a,b){if($(".c-view-settings",a).length){var c="";b.info&&b.info.name?c=b.info.name:b.title&&(c=b.title);$(".c-view-settings",a).show();$("#c-view-delete").show();$("#c-view-name",a).removeClass("error");a.find(".errormsg").remove();$("#c-view-name",a).val()||$("#c-view-name",a).val(c)}else{var c=tmpl("template-contacts-view-settings",
b),d=a.find(".wa-page-heading");d.length?d.after(c):a.append(c);$("#c-view-settings-icons").find("li a").click(function(){$("#c-view-settings-icons").find("li.selected").removeClass("selected");$(this).parent().addClass("selected");return!1});c=$("#c-view-settings-icons").find('li[data-icon="'+$.wa.encodeHTML(b.info.icon)+'"]');c.length?c.closest("li").addClass("selected"):$("#c-view-settings-icons li:first").addClass("selected");a.find("input[name=shared][value="+(0<b.info.shared?1:0)+"]").attr("checked",
!0);var e=function(){$(".wa-page-heading",a).show();$(".c-view-settings",a).hide();$("#c-view-delete").hide();a.height("")};$(window).unbind("resize.view-settings").bind("resize.view-settings",function(){var b=$("#c-view-settings-icons");if(b.length){a.find(".buttons").width("100%");var c=0,d=null,e=null;b.find("li").each(function(){e=$(this);var a=e.position();if(null===d)d=Math.floor(a.top);else if(d!==Math.floor(a.top))return!1;c+=1});c&&(b=(c-1)*e.outerWidth(!0)+e.width(),$("#c-view-name").width(122+
b))}else $(window).unbind("resize.view-settings")}).trigger("resize");$("#c-view-save-button").click(function(){var c={name:($("#c-view-name",a).val()||"").trim()};if($("#c-view-name",a).length&&!c.name)return $("#c-view-name",a).addClass("error").after('<em class="errormsg">'+$_("Required field")+"</em>"),!1;var d="";"view"===b.hash_ar[0]?(c.id=b.info.id,d="?plugin=pro&module=view&action=save"):"prosearch"===b.hash_ar[0]&&(c.hash=b.hash_ar[1],c.count=b.count||0,d="?plugin=pro&module=filter&action=save");
c.icon=$("#c-view-settings-icons li.selected").data("icon");c.icon||delete c.icon;c.shared=a.find("input[name=shared]:checked").val();$.post(d,c,function(d){if(d&&d.status==="ok")if(b.hash_ar[0]==="view"){if(c.id){var g=$(".c-view-list").find('li[data-id="'+c.id+'"]'),f=$.wa.encodeHTML(d.data.name);g.find(".name").html(f);d.data.icon&&g.find(".icon16").attr("class","icon16 "+d.data.icon);var j=b.info.shared;if(c.shared!=j){if(j=="0")$("#c-shared-views").show().append(g.show());else{$("#c-my-views-block").show();
$("#c-all-my-views-toggle").before(g.show())}g=$("#c-my-views-block").find(".view-item").length;$("#c-my-views-block").find(".c-my-views-count").text(g);g===0&&$("#c-my-views-block").hide();if(a.is("#c-my-views-block")){g=$(".view-item",a).length;$(".c-my-views-count",a).text(g);g===0&&a.hide()}else if(a.is("#c-shared-views")){g=a.find("li").length;g===0&&a.hide()}}}$(".wa-page-heading").html(f);if(c.id)$.wa.controller.redispatch();else{f=$("#c-my-views,#c-shared-views");$("#c-my-views-block").trigger("add_new_item",
d.data.view);f.find("li.selected").removeClass("selected");f.find("li:first").addClass("selected");$.wa.setHash("contacts/view/"+d.data.view.id+"/")}e()}else if(b.hash_ar[0]==="prosearch"){(d.data.shared=="1"?$("#c-shared-views"):$("#c-my-views-block")).trigger("add_new_item",d.data);$.wa.controller.setHash("#/contacts/view/"+d.data.id);e()}},"json");return!1});$("#c-view-cancel").click(function(){e()});$("#c-view-delete").show().click(function(){var a=b.info.id,c=function(b){$.post("?plugin=pro&module=view&action=delete",
{id:a},function(c){if(c&&"ok"===c.status){var d=$(".c-view-list").find('li[data-id="'+a+'"]'),c=d.closest(".block");d.remove();c.is("#c-my-views-block")?(d=$(".view-item",c).length,$(".c-my-views-count",c).text(d),0===d&&c.hide()):c.is("#c-shared-views")&&(d=c.find("li").length,0===d&&c.hide())}"function"===typeof b&&b();$.wa.setHash("#/")},"json")};if(0<b.count){var d=$("#c-delete-view");(d.length?d.parent():$("<div></div>").appendTo("body")).load("?plugin=pro&module=view&action=deleteConfirm",{id:a},
function(){var a=$("#c-delete-view");a.waDialog({disableButtonsOnSubmit:!0,onSubmit:function(){a.find(".loading").show();c(function(){a.find(".loading").hide();a.trigger("close")});return!1}})})}else c()})}$(".c-view-settings",a).css({overflow:"hidden","float":"none"})},contactsNew_filterAction:function(){this.contactsSearchAction([],"new_filter")},contactsSearchAction:function(a,b){$.wa.search.init(a,b)},simpleSearch:function(){var a=$.trim($("#search-text").val());if(a){var b="",b=-1!==a.indexOf("@")?
"contact_info.email*="+encodeURIComponent(a):"contact_info.name.name*="+encodeURIComponent(a);$.wa.setHash("#/contacts/search/"+b+"/1/")}},addToViewDialog:function(){if(0>=$.wa.grid.getSelected().length)return!1;$.wa.dialogCreate("c-d-add-to-list",{url:"?plugin=pro&module=view&action=add&view_id="+this.current_view_id})},addToView:function(a,b){$.post("?plugin=pro&module=view&action=save",{"contacts[]":$.wa.grid.getSelected(),"views[]":a||[],name:b||""},function(a){if("ok"===a.status){var b=$("#c-my-views,#c-shared-views"),
e=a.data.counters;if(!$.isEmptyObject(e)&&$.isArray(e))for(var i=0,g=e.length;i<g;i+=1)b.find('li[data-id="'+e[i].id+'"]').find(".count").text(e[i].count);a.data.view?($("#c-my-views-block").trigger("add_new_item",a.data.view),b.find("li.selected").removeClass("selected"),b.find("li:first").addClass("selected"),b="#/contacts/view/"+a.data.view.id+"/",$.wa.controller.stopDispatch(1),$.wa.setHash(b),$.wa.controller.stopDispatch(0),$.wa.controller.dispatch(b,!0)):($.wa.controller.afterInitHTML=function(){$.wa.controller.showMessage(a.data.message)},
$.wa.controller.redispatch())}else $.wa.controller.showMessage(a.data.message)},"json")},dialogRemoveSelectedFromList:function(a){a=a||$.wa.grid.getSelected();!(0>=a.length)&&$.wa.controller.current_view_id&&$.wa.dialogCreate("confirm-remove-from-list-dialog",{content:$("<h2>"+$_("Exclude contacts from list &ldquo;%s&rdquo;?").replace("%s",$.wa.encodeHTML($("h1.wa-page-heading").text()))+"</h2>"),buttons:$("<div></div>").append($('<input type="submit" class="button red" value="'+$_("Exclude")+'">').click(function(){$('<i style="margin: 8px 0 0 10px" class="icon16 loading"></i>').insertAfter(this);
$.post("?plugin=pro&module=view&action=deleteFrom",{view_id:$.wa.controller.current_view_id,contacts:a},function(a){$.wa.dialogHide();$.wa.controller.afterInitHTML=function(){$.wa.controller.showMessage(a.data.message)};$.wa.controller.redispatch()},"json")})).append(" "+$_("or")+" ").append($('<a href="javascript:void(0)">'+$_("cancel")+"</a>").click($.wa.dialogHide)),small:!0})},updateAddNewBlock:function(a){var a=a||"person",b={person:{name:[$_("Person"),$_("New person")],href:"#/contacts/add/"},
company:{name:[$_("Company"),$_("New company")],href:"#/contacts/add/company/"},note:{name:[$_("Note"),$_("New note")],href:"#/contacts/add/note/"},event:{name:[$_("Event"),$_("New event")],href:"#/contacts/add/event/"}};this.admin||delete b.event;var c=["person","company","note","event"];delete c[c.indexOf(a)];this.admin||delete c[c.indexOf("event")];for(var d="",e=0;e<c.length;e+=1)c[e]&&(d+='<li><a href="'+b[c[e]].href+'" class="'+(e===c.length-1?"after-line":"")+'">'+b[c[e]].name[0]+"</a></li>");
$("#add-new-contact-block").html("<a href="+b[a].href+' class="bold no-underline" style="margin-left: 3px; float:left; margin-right: 5px;"><i class="icon16 add"></i>'+b[a].name[1]+'</a><ul class="menu-h dropdown clickable" style="float: left;"><li style="display: inline-block; padding: 0;" id="add-new-contact-item"><a href="javascript:void(0);" class="inline-link open-menu"><b><i>'+$_("or")+'</i></b></a><ul class="menu-v main-menu" style="">'+d+"</ul></li></ul>");this.initClickableMenu($("#add-new-contact-block .clickable"))},
formNewAction:function(){this.formAction([-1])},formAction:function(a){a=a||[];a[0]?$.wa.controller.load($("#c-core"),"?plugin=pro&module=form&current_form_id="+parseInt(a[0])):$.wa.controller.load($("#c-core"),"?plugin=pro&module=form")},mergeduplicatesAction:function(a){var b=function(a){var b={offset:0,order:0,count:30,query:""};a[0]&&(b.offset=parseInt(a[0],10)||0);a[1]&&(b.order=parseInt(a[1],10)||0);a[2]&&(b.count=parseInt(a[2],10)||30);a[3]&&(b.query=a[3]);return b},c=function(){var a=location.hash.indexOf("mergeduplicates/"),
b="";-1!==a&&(b=location.hash.slice(a+16),b=b.split("/"));return b},d=function(a){return"#/mergeduplicates/"+a.offset+"/"+a.order+"/"+a.count+"/"+(a.query?a.query+"/":"")},e=function(a){for(var b={},a=a.split("&"),c=0;c<a.length;c+=1){var d=a[c].split("=");d[0]&&d[1]&&(b[d[0]]=d[1])}return b},i=function(a,b){var a=a.replace(/^[^#]*#\/*/,""),c=$.isEmptyObject($.wa.controller.hashes)||$.wa.controller.hashes[0]!==a;c&&b&&$("#c-search-duplicates-form .buttons .loading").show();$.wa.setHash("/"+a);return c},
g=b(a),h=e(g.query);$.wa.controller.load($("#c-core"),"?plugin=pro&module=backend&action=mergeduplicates",$.extend({},g,h),null,function(){$(window).scrollTop(0,200);$.wa.controller.setTitle($("#c-mergeduplicates-content h1.title").text());$("#c-search-duplicates-form").submit(function(){var a=b(c()),f=e(a.query);f.field=$("#c-search-duplicates-by-field").val();var g=[],h;for(h in f)f.hasOwnProperty(h)&&g.push(h+"="+f[h]);f=g.join("&");a.query=f;i(d(a),!0);return!1});var a=function(a,b){b.merge_result&&
b.merge_result.total_merged===b.merge_result.total_requested?a.closest("tr").find("td:not(:first)").css({textDecoration:"line-through"}).end().find("td:first").html('<a href="#/contact/'+b.master.id+'/" target="_blank">'+$.wa.encodeHTML(b.master.name)+"</a>"):a.addClass("partial");a.closest("td").css({textDecoration:""}).html('<span class="float-right" style="margin-right: 10px;">'+b.message+"</span>").append(a.hide().addClass("finished"))};$("#c-duplicates").on("click",".c-merge",function(){var b=
$(this),c=b.parent().find(".loading").css("opacity",1);$.get("?plugin=pro&module=backend&action=mergeduplicatesGetContacts",{field:$("#c-search-duplicates-by-field").val(),value:b.attr("data-field-value")},function(d){$.isEmptyObject(d.data.contacts)||(c.css("opacity",0),$.wa.controller.load("#c-merge-contacts-content .c-core-content","?module=contacts&action=mergeSelectMaster",{ids:d.data.contacts},null,function(){$("#c-mergeduplicates-content").hide();$("#c-merge-contacts-content").show();$(window).unbind("wa_cancel_merge_contacts").one("wa_cancel_merge_contacts",
function(){$("#c-mergeduplicates-content").show();$("#c-merge-contacts-content").hide();return!1});$(window).unbind("wa_after_merge_contacts").one("wa_after_merge_contacts",function(c,d){d&&"ok"===d.status&&a(b,d.data);$("#c-mergeduplicates-content").show();$("#c-merge-contacts-content").hide();return!1})}))},"json")});$("#c-duplicates-paging").bind("choose_page",function(a,e){var f=c(),f=b(f);f.offset=e;i(d(f))});$("#c-duplicates-paging .items-per-page").bind("change",function(){var a=c(),a=b(a);
a.offset=0;a.count=parseInt($(this).val(),10);i(d(a))});var f=null;$("#c-new-search-link").click(function(){f?f.done(function(){$.wa.setHash("mergeduplicates/")}):$.wa.setHash("mergeduplicates/");return!1});$("#c-auto-merge-dupliactes-open-start-text").click(function(){$("#c-auto-merge-dupliactes-start-text").show()});$(".c-auto-merge-duplicates-start,.c-auto-merge-duplicates-resume").click(function(){var b=$("#c-duplicates"),c=$("#c-search-duplicates-by-field").val();$(".c-auto-merge-duplicates-break").show();
$(".c-auto-merge-duplicates-start,.c-auto-merge-duplicates-resume").hide();$("#c-search-duplicates-form").hide();$("#c-new-search-link").show();$("#c-duplicates-paging").hide();var d=$("#c-auto-merge-dupliactes-total-count").val(),e=0,i=function(){$(".c-auto-merge-duplicates-start,.c-auto-merge-duplicates-resume").hide();$(".c-auto-merge-duplicates-break").hide();$("#c-attention-message").hide();$(".c-done-message").show()},k=function(){var r=b.find(".c-merge:not(.finished):first");if(r.length)r.parent().find(".loading").css("opacity",
1),f=new $.Deferred,f.fail(function(){$("#c-auto-merge-duplicates-loading").hide();$(".c-auto-merge-duplicates-resume").show()}),$.get("?plugin=pro&module=backend&action=mergeduplicatesGetContacts",{field:c,value:r.attr("data-field-value"),master_slaves:1},function(b){b&&"ok"===b.status&&!$.isEmptyObject(b.data)?$.post("?module=contacts&action=merge",{master_id:b.data.master,slave_ids:b.data.slaves},function(b){b&&"ok"===b.status&&a(r,b.data)},"json").always(function(){f.resolve()}):(r.addClass("finished"),
f.resolve())},"json").error(function(){f.resolve()}),f.done(function(){e+=1;k()});else if(e<d){var n=b.find(".c-merge.partial").length;$.get("?plugin=pro&module=backend&action=mergeduplicates",$.extend({},g,h,{offset:n}),function(a){if(a){var a=$("<div>").html(a),b=a.find("#c-duplicates tbody");b.find(".c-mergeduplicates-row:first").length?($("#c-duplicates tbody").append(b.find(".c-mergeduplicates-row")),k()):i();a.remove()}else i()})}else i()};k()});$(".c-auto-merge-duplicates-break").click(function(){$(".c-auto-merge-duplicates-break").hide();
$("#c-auto-merge-duplicates-loading").show();f.reject()})})},settingsRegionAction:function(){this.setBlock();this.load($("#c-core"),"?plugin=pro&module=settings&action=regions")},initClickableMenu:function(a){a.find("a:first").unbind("click").bind("click",function(){$(this).closest(".clickable").find("ul").toggle();return!1});$(window).unbind(".clickable-hide").bind("click.clickable-hide",function(){var b=a.parent();b&&b.length?$(".clickable ul").hide():$(this).unbind(".clickable-hide")})},confirmLeave:function(a,
b,c,d,e){var i,g=$(window),h=(""+Math.random()).slice(2);e&&(h=e);this.confirmLeaveStop(h);g.on("beforeunload."+h,function(){if("function"===typeof d&&d())g.off("."+h);else if(a())return b});g.on("wa_before_dispatched."+h,i=function(e){"function"===typeof d&&d()?$.wa.controller.confirmLeaveStop(h):a()?confirm(b+" "+c)||e.preventDefault():g.off("wa_before_dispatched",i)});return h},confirmLeaveStop:function(a){$(window).off("."+a)}});$.wa.history=$.extend($.wa.history||{},{});var h=$.wa.history.updateHistory||
function(){};$.wa.history=$.extend($.wa.history,{data:null,updateHistory:function(a){for(var b,c=[],d=0,e=a.length;d<e;d+=1)b=a[d],"search"!==b.type&&c.push(b);return h.call(this,c)}});$(window).unbind("wa_before_dispatched.contacts_pro").bind("wa_before_dispatched.contacts_pro",function(a,b){var b=(b||"").replace(/^[^#]*#\/*/,""),c=b.split("/");c[0]=c[0]||"contacts";c[1]=c[1]||"all";("contacts"!==c[0]||"all"!==c[1])&&$("#c-abc-index").hide().remove()});var k=$.wa.controller.showMenus||function(){};
$.wa.controller.showMenus=function(a){k.apply(this,arguments);var b="",b="undefined"===typeof this.options.rights.edit||this.options.rights.edit?'<li class="disabled"><a href="javascript:void(0);" onclick="$.wa.controller.dialogRemoveSelectedFromList(); return false"><i class="icon16 close"></i>'+$_("Exclude from this list")+"</a></li>":'<li class="force-disabled"><a href="javascript:void(0);"><i class="icon16 close"></i>'+$_("Exclude from this list")+"</a></li>",b=(0<=a.indexOf("list-actions")&&
this.current_view_id?b:"")+($.wa.controller.addToViewDialog?'<li class="disabled"><a href="#" onclick="$.wa.controller.addToViewDialog(); return false"><i class="icon16 add-to-list"></i>'+$_("Add to list")+"</a></li>":"");(b+='<li class="disabled"><a href="#" onclick="$.wa.controller.export(); return false;" class="red" id="c-export"><i class="icon16 export"></i>'+$_("Export")+"</a></li>")&&$("#actions-with-selected").prepend(b);$("#list-views").append('<li rel="map"><a href="#" title="'+$_("Map")+
'" id="c-view-map-link"><i class="icon16 map"></i></a></li>');$("#add-to-category-link").remove()};var n=$.wa.controller.deleteCustomField||function(){};$.wa.controller.deleteCustomField=function(a){n.apply(this,arguments);for(var b="all",c=location.hash.replace(/^[^#]*#\/*/,""),d=c.split("/"),b=d[1],d=d.slice(2),e=this.parseCustomFields(d,b),d=[],i=0;i<e.length;i+=1)e[i]!==a&&d.push(e[i]);e=this.parseHash(c,b);e.custom_fields=d.join("&");c=this.makeHash(e,b);this.stopDispatch(1);$.wa.setHash("#/"+
c);d.length||this.expandCustomFieldsControl();this.customFieldsControlCheckItems(d);"all"===b?$.storage.set("contacts/all/custom_fields",d):(e.id=parseInt(e.id,10),"view"===b&&e.id&&$.post("?plugin=pro&module=contacts&action=listFields",{contacts:[],custom_fields:e.custom_fields,view_id:e.id}))};$.wa.grid&&($.wa.grid.viewmap=function(a){for(var b=[],c=new google.maps.LatLngBounds,d=a.contacts,e=0;e<d.length;e+=1){var i=d[e];if(!$.isEmptyObject(i.address))for(var g=0;g<i.address.length;g+=1){var h=
i.address[g];h.data.lat&&h.data.lng&&(h={latLng:new google.maps.LatLng(h.data.lat.replace(",","."),h.data.lng.replace(",",".")),contact:i,address:{value:h.value}},c.extend(h.latLng),b.push(h))}}a.geolocations_stats=a.geolocations_stats||{contacts_count:0,points_count:0,message:""};$("#c-list-toolbar-menu-wrapper").html('<div style="height: 20px; padding-top: 3px;" class="map-report"></div>');a=a.geolocations_stats.message;a=a.replace("%HREF%","javascript:void(0)").replace("%CLASS%","c-explain-dialog-link");
$("#c-list-toolbar-menu-wrapper").find(".map-report").html(a);$("#c-list-toolbar-menu-wrapper").find(".map-report .c-explain-dialog-link").click(function(){$.wa.dialogCreate("c-explain-dialog",{content:"<h1>"+$_("Why some contacts do not have geolocation info")+"</h1><p>"+$_("Webasyst uses Google Maps service to identify geolocation associated with a contact address. This occurs when you add or edit contacts. However, we do not send requests to Google while you perform bulk operations, e.g. contact import, because of Google limits.Also contacts added before Webasyst Contacts Pro plugin installation do not have geolocation info in their records.")+
"</p><p>"+$_("ADVICE: To update geolocation for any contact, open it, enter a valid address, and click Save button.")+"</p>",buttons:$('<input type="button" class="button gray" value="'+$_("Close")+'">').click(function(){$.wa.dialogHide()})})});0>=b.length&&$("#c-list-toolbar-menu-wrapper").find(".map-report").css("color","red");var k=null,a=$("#map-canvas"),d=$(window);a.length||($('<div id="map-canvas" style="width: 100%;"></div>').appendTo($("#contacts-container .contacts-data")),a=$("#map-canvas"),
a.height(Math.max(d.height()-(a.offset().top||0)-30,0)));k=new google.maps.Map($("#map-canvas").get(0),{zoom:b.length?15:1,center:c.getCenter(),mapTypeId:google.maps.MapTypeId.ROADMAP});0<b.length&&(a=c.getNorthEast(),d=c.getSouthWest(),(0.0045<=Math.abs(d.lng()-a.lng())||0.0045<=Math.abs(d.lat()-a.lat()))&&k.fitBounds(c));for(var f=new google.maps.InfoWindow({content:"",maxWidth:250}),e=0;e<b.length;e+=1)b[e].marker=new google.maps.Marker({position:b[e].latLng,map:k}),function(a){google.maps.event.addListener(b[a].marker,
"click",function(){var c=b[a],d=c.contact,e=$.wa.grid.formNamesHtml(d);f.setContent('<h2 style="font-size: 1.1em; margin-bottom: 6px;"><a class="no-underline" href="#/contact/'+d.id+'/">'+(e[0]||"")+'</a></h2><p style="font-size: 0.9em;">'+c.address.value+"</p>");f.open(k,c.marker)})}(e);$("#c-core .clear-left").remove()});$(window).unbind("wa-dispatched.contacts_pro").bind("wa-dispatched.contacts_pro",function(){$("#wa").removeClass("c-search")})})();(function(h){h.fn.periodDialog=function(k,n){function a(a){return h.datepicker.formatDate(a,new Date(this.find(".datepicker.start").datepicker("getDate")))}function b(a){return h.datepicker.formatDate(a,new Date(this.find(".datepicker.end").datepicker("getDate")))}function c(a,b,c){return h.datepicker.formatDate(a,new Date(b),c)}if(!this.length)return this;if("getStartDate"===k)return a();if("getEndDate"===k)return b();if("formatDate"===k)return c.apply(this,Array.prototype.slice.call(arguments,1));
var d={};"object"===typeof k&&(this.data("periodDialogOptions",h.extend({start_datetime:null,end_datetime:null},k)),d=this.data("periodDialogOptions"));var e=this;e.html('<table width="100%;"><tr><td align="center"><div class="datepicker start"></div></td><td align="center">&mdash;</td><td align="center"><div class="datepicker end"></div></td></tr></table>');var i='<input type="submit" class="button green" value="'+$_("Apply")+'"> '+$_("or")+' <a class="cancel" href="javascript:void(0);">'+$_("cancel")+
"</a>";e.waDialog({buttons:i,onLoad:function(){e.find(".datepicker").datepicker();d.start_datetime&&e.find(".datepicker.start").datepicker("setDate",h.datepicker.parseDate("yy-mm-dd",d.start_datetime));d.end_datetime&&e.find(".datepicker.end").datepicker("setDate",h.datepicker.parseDate("yy-mm-dd",d.end_datetime))},onSubmit:function(){var a=h(this),b=a.find(".start").datepicker("getDate"),a=a.find(".end").datepicker("getDate");e.trigger("select",[b,a]);e.trigger("close");return false}}).find(".cancel").click(function(){e.trigger("cancel")});
return e}})(jQuery);(function(h){h.fn.inlineEditable=function(k,n){function a(){m(h(this))||h(this).addClass(f.placeholderClass).text(f.placeholder)}function b(){m(h(this))==f.placeholder&&h(this).text("").removeClass(f.placeholderClass)}function c(a){return!h(a).val()?(h(this).text(f.placeholder).addClass(f.placeholderClass),!0):!1}function d(){p="edit";this.id=this.id||(""+Math.random()).slice(2);var a=this.id+"-input",c=h("#"+a);c.length||(o.after(i(a)),c=h("#"+a));c.addClass(f.inputClass);var a=c,d=o,g=f.size.height||
d.height(),d=f.size.width||1.5*d.width(),g=f.minSize.height&&g<f.minSize.height?f.minSize.height:g,d=f.minSize.width&&d<f.minSize.width?f.minSize.width:d,g=f.maxSize.height&&g>f.maxSize.height?f.maxSize.height:g,d=f.maxSize.width&&d>f.maxSize.width?f.maxSize.width:d;a.height(g);a.width(d);f.placeholder&&m(h(this))==f.placeholder&&b.call(o);f.beforeMakeEditable.call(this,c);q=f.truncate?o.data("real_text"):m(o);c.val(q).show().focus();o.hide();h(f.editLink).hide();if(!l){for(var j=[],k=[],a=0,g=f.makeReadableBy.length;a<
g;++a)d=f.makeReadableBy[a],"blur"==d&&c.blur(function(){p!="read"&&e.call(this)}),"enter"==d&&j.push(13),"esc"==d&&j.push(27);a=0;for(g=f.updateBy.length;a<g;++a)d=f.updateBy[a],"alt+enter"==d&&k.push({ctrl:!1,alt:!0,shift:!1,key:13}),"ctrl+enter"==d&&k.push({ctrl:!0,alt:!1,shift:!1,key:13}),"ctrl+s"==d&&k.push({ctrl:!0,alt:!1,shift:!1,key:17});j.length&&c.keydown(function(a){~j.indexOf(a.keyCode)&&!a.ctrlKey&&!a.altKey&&!a.shiftKey&&p!="read"&&e.call(this,a.keyCode==27?q:null);if(k.length)for(var b in k){var c=
k[b];if(a.keyCode==c.key&&a.ctrlKey==c.ctrl&&a.altKey==c.alt&&a.shiftKey==c.shift){o.trigger("readable");break}}});o.unbind("readable.inlineEditable").bind("readable.inlineEditable",function(a,b,c){if(p!="read"){a=h("#"+(this.id+"-input"));e.call(a,a.val(),b,c)}});l=!0}f.afterMakeEditable.call(this,c)}function e(b,d,e){d="undefined"===typeof d?!1:!0;void 0!=b&&null!=b?h(this).val(b):b=h(this).val();if(!(!1===d&&!1===f.beforeBackReadable.call(o.get(0),this,{changed:b!=q,old_text:q,new_text:b}))){p=
"read";if(!e&&(!f.placeholder||!c.call(o,this)))if(f.allowEmpty||b){if(f.truncate)o.data("real_text",b),o.text(b.length<f.truncate-3?b:b.substr(0,f.truncate-3)+"...");else{var e=o,g=b;f.html?e.html(g):f.nl2br?e.html(h.wa.encodeHTML(g).replace(/\n/g,"<br>")):e.text(g)}b||a.call(this)}o.show();h(this).hide();h(f.editLink).show();!1===d&&f.afterBackReadable.call(o.get(0),this,{changed:b!=q,old_text:q})}}function i(a){switch(f.inputType){case "textarea":return'<textarea id="'+a+'" style="display:none;"></textarea>';
default:return'<input type="text" id="'+a+'" style="display:none;">'}}function g(a){return function(){return a}}function m(a){var b="";return b=f.html?f.nl2br?a.html().replace(/<br>/g,"\n"):a.html():f.nl2br?h.wa.decodeHTML(a.html().replace(/<br>/g,"\n")):a.text()}if(this.length){var l=!1;if("string"==typeof k){if("setOption"==k){var f=this.data("inlineEditableSettings")||{};h.extend(!0,f,n);"undefined"!==typeof n.hold&&"function"!==typeof n.hold&&(f.hold=g(f.hold));this.data("inlineEditableSettings",
f)}return this}var j=this.data("inlineEditableSettings");this.data("inlineEditableSettings",h.extend({inputType:"text",inputClass:"",size:{height:null,width:null},minSize:{height:null,width:null},maxSize:{height:null,width:null},editLink:null,editOnItself:!0,placeholder:null,makeReadableBy:["blur","enter","esc"],updateBy:["ctrl+enter","alt+enter"],beforeBackReadable:function(){},afterBackReadable:function(){},beforeMakeEditable:function(){},afterMakeEditable:function(){},placeholderClass:"hint",truncate:!1,
hold:!1,html:!1,allowEmpty:!1,nl2br:!1},j,k||{}));var f=this.data("inlineEditableSettings")||{},o=this,p="read",q="";"function"!==typeof f.hold&&(f.hold=g(f.hold));this.data("inited")||(f.truncate&&"boolean"==typeof f.truncate&&(f.truncate=255),f.truncate&&(j=!f.placeholder||f.placeholder!==this.text()?this.text():"",this.data("real_text",j),this.text(j.length<f.truncate-3?j:j.substr(0,f.truncate-3)+"...")),f.placeholder&&a.call(this),f.editLink&&h(f.editLink).unbind("click.inlineEditable").bind("click.inlineEditable",
function(){f.hold.call(o)||p!="edit"&&d.call(o.get(0))}),f.editOnItself&&this.unbind("click.inlineEditable").bind("click.inlineEditable",function(){f.hold.call(o)||p!="edit"&&d.call(this)}),this.unbind("editable.inlineEditable").bind("editable.inlineEditable",function(){f.hold.call(o)||p!="edit"&&d.call(this)}),this.unbind("placeholder.inlineEditable").bind("placeholder.inlineEditable",function(b,c){c&&f.placeholder&&a.call(this);c||h(this).removeClass(f.placeholderClass)}),this.data("inited",!0));
return this}}})(jQuery);
